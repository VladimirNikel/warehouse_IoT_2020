# Администрирование складских помещений (ангара)

## Суть: 
> Имеется ангар, в нём произведено разделение на комнаты, в каждую комнату устанавливается конечное устройство с датчиками и lora-модулем. Со всех конечных устройств передаются данные собираемые с комнаты.
> Ниже приведено расположение устройств в ангаре:
![расположение устройств в ангаре](https://sun9-13.userapi.com/48xV6J1zNH9I4HNhDDLL26xvvNkn0E4JD6l_ng/NJ2jKLPE-U0.jpg)
> На рисунке ниже отображена схема взаимодействия элементов между собой:
![взаимодействие элементов между собой](https://sun9-64.userapi.com/HIFDK5W03gO3lhJ4O2pKFL6nfn3CzALq9XP3iQ/NHYcWcvG0ko.jpg)

## Инструкция по установке всего:
**1. Настройка среды разработки**

```
sudo apt install libusb-1.0-0-dev
sudo apt install cmake
sudo apt install gcc-arm-none-eabi
sudo apt install gtkterm
sudo apt install mosquitto -y
sudo apt install mosquitto-dev -y
sudo apt install libc-ares-dev
sudo apt install libc-ares2
sudo apt install libssl-dev
sudo apt install xsltproc
sudo apt install libmosquitto-dev

```

Далее переходим в любую удобную папку и выполняем следующую команду:

```
git clone https://github.com/unwireddevices/stm32flash
cd stm32flash
sudo make
sudo make install
```

**2. Основная работа**

* 2.1 Далее нужно скачать данный репозиторий.
* 2.2 Подключить плату UMDK-RF к компьютеру в режиме загрузчика (удерживать после подключения клавишу `boot/power`, после перемигивания лампочки прекратить нажатия клавиши)
* 2.3 Выполнить команду `sudo stm32flash -E -w loralan-gateway.hex -v /dev/ttyACM0` в которой вместо `loralan-gateway.hex` будет указатель на имя hex-файла, и вместо `/dev/ttyACM0` будет имя порта


**3. Взаимодействие с самим устройством**

* 3.1 Не подключая устройство к компьютеру наберите команду `ls /dev` в терминале - Вам отобразится список подключенных устройств. Пока его запоминать не надо.
Затем подключите устройство (базовую станцию) к компьютеру и снова выполните команду `ls /dev` и присмотритесь к устройствам с именем, начинающимся на _tty_ - чаще всего устройство будет иметь имя _ttyACM0_. Запомните имя подключенного устройства, оно пригодится вам позже.
* 3.2 Запускается gtkterm командой `sudo gtkterm`
* 3.3 В пункте `Configuration` выбирается `CR LF auto`
* 3.4 В пункте `Configuration` выбирается `Port` и производится настройка на прослушивание порта устройства (обычно: _ttyACM0_ - имя устройства из пункта 3.1) и выставляется скорость (_Baud Rate_) в значение `115 200`
* 3.5 При желании можно сохранить конфигурацию
* 3.6 При подключении устройства через порт USB будет отображена информация, поступающая с этого устройства. Также, через данное приложение можно посылать информацию на плату
* 3.7 Сборка [по инструкции](https://sdo.tusur.ru/mod/page/view.php?id=31212), использовать `sudo make clean` 


**4. Развертывание (делается вроде один раз)**
- изменили в файле `/etc/lora-mqtt/mqtt.conf` имя устройства c _tty_ на _ttyUSB*_
- Подключается плата, которая будет "базовой станцией" по обычному подключению (через miniUSB)
	+ Определяется ее порт (_ttyACM*_, где вместо _"*"_ может быть число согласно списку подключенных устройств)
	+ Плата переводится в режим программирования
		+ После подключения платы загорается светодиод и постоянно светится
		+ Необходимо удерживать (около секунды) клавишу `Boot/Power`
		+ Если светодиод перемигивает - значит плата находится в режиме программирования
	+ Выполняется команда `sudo stm32flash -E -w loralan-gateway.hex -v /dev/ttyACM0` (либо же другой порт, если он отличается)
	+ Необходимо дождаться окончания загрузки прошивки, после чего можно отключать устройство от компьютера. Пока что...
- Подключается плата, которая будет "конечным устройством" по обычному подключению (через miniUSB)
	+ Определяется ее порт (_ttyACM*_, где вместо _"*"_ может быть число согласно списку подключенных устройств)
	+ Плата переводится в режим программирования
		+ После подключения платы загорается светодиод и постоянно светится
		+ Необходимо удерживать (около секунды) клавишу `Boot/Power`
		+ Если светодиод перемигивает - значит плата находится в режиме программирования
	+ Выполняется команда `sudo stm32flash -E -w loralan-public.hex -v /dev/ttyACM0` (либо же другой порт, если он отличается)
	+ Необходимо дождаться окончания загрузки прошивки, после чего можно отключать устройство от компьютера. Пока что...
- Далее необходимо приступить к настройке плат:
	+ Подключаем сначала плату с загруженной прошивкой _loralan-gateway.hex_, т.е. "базовая станция"
		+ Необходимо через команду `sudo gtkterm` настроить прослушивание порта, к которому подключена плата
			+ Поможет в определении команда `ls /dev`
		+ После подключения необходимо выполнить команду:
			+ `set JOINKEY XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX` - 32 символа
			+ `set EUI64 `
			+ `set APPID64 `
		+ После выполнения вышеуказаныных команд:
			+ Выполняется команда `Save`
			+ И команда `Reboot`
	+ Теперь подключаем плату с загруженной прошивкой _loralan-public.hex_, т.е. конечное устройство
		+ Необходимо через команду `sudo gtkterm` настроить прослушивание порта, к которому подключена плата
			+ Поможет в определении команда `ls /dev`
		+ После подключения необходимо выполнить команду:
			+ `set JOINKEY XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX` - 32 символа (точно такой же как и на плате - базовой станции)
			+ `set EUI64 `
			+ `set APPID64 `
		+ После выполнения вышеуказаныных команд:
			+ Выполняется команда `Save`
			+ И команда `Reboot`



**5. Обычная работа (для демонстрации работы)**
- Подключается плата базовой станции (через UART)
	+ `GND` с UART'a соединяется с любым `GND` на плате
	+ `TXD` с UART'а соединяется с `26` пином на плате
	+ `RXD` с UART'а соединяется с `25` пином на плате
- Можно выполнить подключение через `sudo gtkterm` по обычному подключению к плате базовой станции (miniUSB) - настроившись на прослушивание порта (по которому подключена данная плата - _ttyACM*_)
	+ проверить можно через команду `ls /dev` до и после подключения устройства
- Необходимо также выполнить подключение конечного устройства к компьютеру, через стандартное подключение (miniUSB), также просматривать получаемую информацию через `sudo gtkterm`
- Далее необходимо выполнить команду `sudo mqtt`, чтобы отображалось то, что приходит на базовую станцию
	+ И в отдельном терминале выполнить команду `mosquitto_sub  -t "devices/lora/#" -q 1` которая позволяет выводить через mosquitto-сеть данные, которые в этой сети "гуляют"

**Чтобы не забыть:**
- `loralan-gateway.hex` лежит в папке `/dev/IoT/UNWD-RIOT/apps/loralan-gateway/bin/unwd-range-l1-r3`
	+ Данный файл был залит на "сервер"...

- HEX'ы скачаны [отсюда](https://github.com/unwireddevices/RIOT/releases)



...